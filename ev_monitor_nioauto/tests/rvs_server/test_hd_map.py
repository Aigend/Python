""" 
@author:dun.yuan
@time: 2021/10/15 12:02 下午
@contact: dun.yuan@nio.com
@description: https://nio.feishu.cn/docs/doccnQU9yqtvbVxdXy2YGrePKjg NT1众包地图需求
@showdoc：
"""
import allure
import json
import base64
import pytest
import time
from utils.assertions import assert_equal
from utils.time_parse import timestamp_to_utc_strtime

case = ['sends speed_event', 'sends snapshot_event', 'sends geometry_event', 'sends geofence_event']
param_event_data = [
{'map_version': 'baidu_10125', 'event_type': 1, 'event_gps': {'type': 'Point', 'coordinates': [121.16617594, 31.28427127]}, 'link_id': '1251600', 'off_set': 0, 'speed': 118, 'confidence': 0, 'uploader': 'yufeng', 'upload_timestamp': 1634113783262, 'verify_status': True, 'verify_timestamp': 3211231111, 'verify_person': '', 'sink_status': True, 'sink_timestamp': 1634188077, 'revert_status': False, 'revert_timestamp': 0, 'revert_person': '', 'commit_content': '1014speed event test_1'},
{'map_version': 'baidu_10124', 'event_type': 2, 'event_gps': {'type': 'Point', 'coordinates': [121.16617594, 31.28427127]}, 'link_id': '1234561223', 'shot_type': 2, 'gps_list': {'type': 'LineString', 'coordinates': [[105.6005859375, 30.6568155642929], [107.95166015625, 31.9894418379229], [109.3798828125, 30.0310554265402], [107.7978515625, 29.9358952133724]]}, 'delta_t_ms': 1628143486, 'uploader': 'xiefei', 'upload_timestamp': 0, 'verify_status': True, 'verify_timestamp': 321123111, 'verify_person': '', 'sink_status': True, 'sink_timestamp': 1634119594, 'revert_status': False, 'revert_timestamp': 0, 'revert_person': '', 'commit_content': '1013snapshot_test_2', 'count': 10},
{'map_version': 'baidu_10125', 'event_type': 3, 'event_gps': {'type': 'Point', 'coordinates': [121.16617594, 31.28427127]}, 'cs_links': [{'link_id': '75056', 'link_length': 90.0199966430664, 'link_class': 1, 'travel_direction': 1, 'link_type': 0, 'lane_num': 6, 'is_tunnel': 0, 'is_bridge': 0, 'is_toll_booth': 0, 'usability_status': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.166469, 31.264859], [121.1664892, 31.2648377], [121.1665094, 31.2648165], [121.1665295, 31.2647953], [121.1665497, 31.264774], [121.16657, 31.2647528], [121.1665903, 31.2647316], [121.1666106, 31.2647105], [121.166631, 31.2646894], [121.1666515, 31.2646684], [121.1666719, 31.2646473], [121.1666924, 31.2646263], [121.1667129, 31.2646052], [121.1667333, 31.2645842], [121.1667538, 31.2645632], [121.1667743, 31.2645422], [121.1667948, 31.2645212], [121.1668155, 31.2645002], [121.1668361, 31.2644793], [121.1668568, 31.2644584], [121.1668774, 31.2644375], [121.1668981, 31.2644166], [121.1669187, 31.2643957], [121.1669393, 31.2643748], [121.1669599, 31.2643538], [121.1669805, 31.2643329], [121.1670012, 31.264312], [121.167022, 31.2642912], [121.1670429, 31.2642704], [121.1670632, 31.2642503], [121.1670766, 31.264237]]}, 'adas_info': [{'curvature': -28.0, 'heading': 140.72, 'slope': 1.0, 'off_set': 0}, {'curvature': -28.0, 'heading': 140.78, 'slope': 1.0, 'off_set': 304}, {'curvature': -27.0, 'heading': 140.79, 'slope': 1.0, 'off_set': 608}, {'curvature': -26.0, 'heading': 140.75, 'slope': 1.0, 'off_set': 912}, {'curvature': -25.0, 'heading': 140.66, 'slope': 1.0, 'off_set': 1216}, {'curvature': -25.0, 'heading': 140.52, 'slope': 1.0, 'off_set': 1520}, {'curvature': -24.0, 'heading': 140.37, 'slope': 0.0, 'off_set': 1824}, {'curvature': -23.0, 'heading': 140.25, 'slope': 0.0, 'off_set': 2128}, {'curvature': -23.0, 'heading': 140.17, 'slope': 0.0, 'off_set': 2432}, {'curvature': -23.0, 'heading': 140.13, 'slope': 0.0, 'off_set': 2736}, {'curvature': -23.0, 'heading': 140.12, 'slope': 0.0, 'off_set': 3040}, {'curvature': -23.0, 'heading': 140.14000000000001, 'slope': 0.0, 'off_set': 3344}, {'curvature': -23.0, 'heading': 140.13000000000002, 'slope': 0.0, 'off_set': 3648}, {'curvature': -23.0, 'heading': 140.09000000000003, 'slope': 0.0, 'off_set': 3952}, {'curvature': -23.0, 'heading': 140.02000000000004, 'slope': 0.0, 'off_set': 4256}, {'curvature': -23.0, 'heading': 139.92000000000004, 'slope': 0.0, 'off_set': 4560}, {'curvature': -23.0, 'heading': 139.79000000000005, 'slope': 0.0, 'off_set': 4864}, {'curvature': -23.0, 'heading': 139.69000000000005, 'slope': -2.0, 'off_set': 5168}, {'curvature': -23.0, 'heading': 139.64000000000004, 'slope': -2.0, 'off_set': 5472}, {'curvature': -23.0, 'heading': 139.63000000000005, 'slope': -2.0, 'off_set': 5776}, {'curvature': -24.0, 'heading': 139.67000000000004, 'slope': -2.0, 'off_set': 6080}, {'curvature': -24.0, 'heading': 139.75000000000006, 'slope': -2.0, 'off_set': 6384}, {'curvature': -24.0, 'heading': 139.82000000000005, 'slope': 1.0, 'off_set': 6688}, {'curvature': -25.0, 'heading': 139.83000000000004, 'slope': 1.0, 'off_set': 6992}, {'curvature': -25.0, 'heading': 139.76000000000005, 'slope': 1.0, 'off_set': 7296}, {'curvature': -26.0, 'heading': 139.61000000000004, 'slope': 1.0, 'off_set': 7600}, {'curvature': -27.0, 'heading': 139.39000000000004, 'slope': 1.0, 'off_set': 7904}, {'curvature': -27.0, 'heading': 139.14000000000004, 'slope': 1.0, 'off_set': 8208}, {'curvature': -27.0, 'heading': 139.06000000000003, 'slope': 1.0, 'off_set': 8512}, {'curvature': -28.0, 'heading': 139.13000000000002, 'slope': 1.0, 'off_set': 8808}, {'curvature': -27.0, 'heading': 139.13000000000002, 'slope': 1.0, 'off_set': 9002}], 'successor_link_ids': ['888888'], 'predecessor_link_ids': ['75059'], 'lanes': [{'lane_id': '237600', 'link_id': '75056', 'lane_idx_raw': 1, 'lane_type': 3, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 0, 'max_speed_limit': 0, 'width': 2.819999933242798, 'length': 90.43000030517578, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731509', 'side': 0, 'mark_type': 3, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.4, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.166314, 31.2647497], [121.1663473, 31.264715], [121.1663806, 31.2646803], [121.1664042, 31.2646558], [121.1664277, 31.2646313], [121.1664612, 31.2645966], [121.1664946, 31.264562], [121.1665161, 31.2645397], [121.1665377, 31.2645175], [121.1665712, 31.2644829], [121.1666047, 31.2644483], [121.1666258, 31.2644264], [121.166647, 31.2644046], [121.1666809, 31.2643703], [121.1667148, 31.264336], [121.1667364, 31.2643141], [121.166758, 31.2642923], [121.166792, 31.264258], [121.166826, 31.2642238], [121.1668474, 31.2642021], [121.1668689, 31.2641805], [121.1668968, 31.2641528], [121.1669246, 31.2641251]]}}, {'mark_id': '731510', 'side': 1, 'mark_type': 0, 'color': 0, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.46, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1662911, 31.2647336], [121.1663248, 31.2646992], [121.1663585, 31.2646647], [121.1663821, 31.2646406], [121.1664057, 31.2646164], [121.1664394, 31.264582], [121.1664732, 31.2645475], [121.1664944, 31.2645258], [121.1665156, 31.2645041], [121.1665491, 31.2644695], [121.1665826, 31.2644348], [121.1666044, 31.2644122], [121.1666262, 31.2643896], [121.1666597, 31.264355], [121.1666932, 31.2643204], [121.1667146, 31.2642984], [121.1667359, 31.2642764], [121.1667698, 31.2642421], [121.1668038, 31.2642078], [121.1668254, 31.264186], [121.166847, 31.2641642], [121.1668744, 31.2641363], [121.1669018, 31.2641083]]}}, {'mark_id': '805932', 'side': 1, 'mark_type': 17, 'color': 0, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.41, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.16629, 31.26473], [121.1663075, 31.2647119], [121.1663251, 31.2646939], [121.1663524, 31.2646674], [121.1663796, 31.26464], [121.1664035, 31.2646129], [121.1664297, 31.2645863], [121.166457, 31.2645603], [121.1664834, 31.264532], [121.1665104, 31.2645042], [121.1665354, 31.2644752], [121.1665629, 31.2644477], [121.1665905, 31.2644203], [121.1666181, 31.2643929], [121.1666451, 31.264365], [121.1666721, 31.2643371], [121.1666991, 31.2643093], [121.166726, 31.2642814], [121.166753, 31.2642536], [121.16678, 31.2642257], [121.1668079, 31.2641983], [121.1668366, 31.2641714], [121.1668641, 31.2641439], [121.1668914, 31.2641163], [121.1668997, 31.2641079], [121.1669014, 31.2641061]]}}, {'mark_id': '10643841', 'side': 1, 'mark_type': 11, 'color': 0, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 29.0, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664253, 31.2645915], [121.1664456, 31.2645709], [121.166466, 31.2645502], [121.1664862, 31.2645294], [121.1665064, 31.2645086], [121.1665264, 31.2644877], [121.1665464, 31.2644668], [121.1665667, 31.2644461], [121.1665869, 31.2644254], [121.1666141, 31.2643979], [121.1666209, 31.264391]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.1663025, 31.2647417], [121.1663361, 31.2647071], [121.1663696, 31.2646725], [121.1663933, 31.264648], [121.166417, 31.2646236], [121.1664506, 31.264589], [121.1664842, 31.2645545], [121.1665057, 31.2645323], [121.1665272, 31.2645102], [121.1665607, 31.2644756], [121.1665942, 31.264441], [121.1666154, 31.264419], [121.1666366, 31.2643971], [121.1666703, 31.2643627], [121.166704, 31.2643282], [121.1667256, 31.2643061], [121.1667472, 31.2642841], [121.1667812, 31.2642498], [121.1668152, 31.2642155], [121.1668365, 31.2641939], [121.1668579, 31.2641724], [121.1668856, 31.2641445], [121.1669132, 31.2641167]]}, 'successor_lane_ids': ['237586'], 'precursor_lane_ids': ['2469323'], 'obj_basic_vct': [], 'adas_info': []}, {'lane_id': '237604', 'link_id': '75056', 'lane_idx_raw': 2, 'lane_type': 7, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 0, 'max_speed_limit': 120, 'width': 3.9200000762939453, 'length': 90.3499984741211, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731507', 'side': 0, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 1.0, 'length': 90.31, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.166346, 31.2647723], [121.1663793, 31.2647376], [121.1664127, 31.2647029], [121.1664362, 31.2646784], [121.1664597, 31.2646539], [121.1664932, 31.2646193], [121.1665267, 31.2645848], [121.166548, 31.2645629], [121.1665692, 31.264541], [121.1666027, 31.2645063], [121.1666361, 31.2644717], [121.1666573, 31.2644497], [121.1666786, 31.2644277], [121.1667125, 31.2643935], [121.1667465, 31.2643592], [121.166768, 31.2643375], [121.1667896, 31.2643158], [121.1668233, 31.2642814], [121.1668571, 31.264247], [121.1668784, 31.2642252], [121.1668997, 31.2642034], [121.1669278, 31.2641758], [121.1669558, 31.2641481]]}}, {'mark_id': '731508', 'side': 1, 'mark_type': 3, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.4, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.166314, 31.2647497], [121.1663473, 31.264715], [121.1663806, 31.2646803], [121.1664042, 31.2646558], [121.1664277, 31.2646313], [121.1664612, 31.2645966], [121.1664946, 31.264562], [121.1665161, 31.2645397], [121.1665377, 31.2645175], [121.1665712, 31.2644829], [121.1666047, 31.2644483], [121.1666258, 31.2644264], [121.166647, 31.2644046], [121.1666809, 31.2643703], [121.1667148, 31.264336], [121.1667364, 31.2643141], [121.166758, 31.2642923], [121.166792, 31.264258], [121.166826, 31.2642238], [121.1668474, 31.2642021], [121.1668689, 31.2641805], [121.1668968, 31.2641528], [121.1669246, 31.2641251]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.16633, 31.264761], [121.1663633, 31.2647263], [121.1663967, 31.2646916], [121.1664202, 31.2646671], [121.1664437, 31.2646426], [121.1664772, 31.264608], [121.1665107, 31.2645734], [121.1665322, 31.2645512], [121.1665537, 31.2645289], [121.1665872, 31.2644943], [121.1666207, 31.2644597], [121.1666417, 31.2644379], [121.1666628, 31.2644162], [121.1666967, 31.2643819], [121.1667307, 31.2643476], [121.1667522, 31.2643258], [121.1667738, 31.264304], [121.1668077, 31.2642697], [121.1668415, 31.2642354], [121.1668629, 31.2642137], [121.1668843, 31.264192], [121.1669123, 31.2641643], [121.1669402, 31.2641366]]}, 'successor_lane_ids': ['237605'], 'precursor_lane_ids': ['237601'], 'obj_basic_vct': [], 'adas_info': []}, {'lane_id': '237590', 'link_id': '75056', 'lane_idx_raw': 3, 'lane_type': 0, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 60, 'max_speed_limit': 120, 'width': 3.869999885559082, 'length': 90.2699966430664, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731505', 'side': 0, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.23, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1663773, 31.2647944], [121.1664107, 31.2647597], [121.1664441, 31.264725], [121.1664674, 31.2647007], [121.1664908, 31.2646764], [121.1665243, 31.2646419], [121.1665578, 31.2646073], [121.166579, 31.2645854], [121.1666003, 31.2645635], [121.1666337, 31.2645288], [121.1666671, 31.2644941], [121.1666882, 31.2644722], [121.1667093, 31.2644503], [121.1667433, 31.264416], [121.1667773, 31.2643817], [121.1667987, 31.2643601], [121.1668202, 31.2643384], [121.1668541, 31.2643041], [121.166888, 31.2642698], [121.1669095, 31.2642481], [121.1669311, 31.2642264], [121.1669589, 31.2641987], [121.1669868, 31.264171]]}}, {'mark_id': '731506', 'side': 1, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 1.0, 'length': 90.31, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.166346, 31.2647723], [121.1663793, 31.2647376], [121.1664127, 31.2647029], [121.1664362, 31.2646784], [121.1664597, 31.2646539], [121.1664932, 31.2646193], [121.1665267, 31.2645848], [121.166548, 31.2645629], [121.1665692, 31.264541], [121.1666027, 31.2645063], [121.1666361, 31.2644717], [121.1666573, 31.2644497], [121.1666786, 31.2644277], [121.1667125, 31.2643935], [121.1667465, 31.2643592], [121.166768, 31.2643375], [121.1667896, 31.2643158], [121.1668233, 31.2642814], [121.1668571, 31.264247], [121.1668784, 31.2642252], [121.1668997, 31.2642034], [121.1669278, 31.2641758], [121.1669558, 31.2641481]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.1663617, 31.2647834], [121.166395, 31.2647487], [121.1664284, 31.2647139], [121.1664519, 31.2646894], [121.1664755, 31.2646649], [121.166509, 31.2646303], [121.1665425, 31.2645957], [121.1665638, 31.2645738], [121.166585, 31.2645519], [121.1666184, 31.2645173], [121.1666519, 31.2644826], [121.1666729, 31.2644608], [121.1666939, 31.264439], [121.1667279, 31.2644047], [121.1667619, 31.2643705], [121.1667835, 31.2643486], [121.1668051, 31.2643268], [121.166839, 31.2642925], [121.1668728, 31.2642581], [121.1668941, 31.2642365], [121.1669154, 31.2642149], [121.1669433, 31.2641872], [121.1669713, 31.2641595]]}, 'successor_lane_ids': ['237592'], 'precursor_lane_ids': ['237559'], 'obj_basic_vct': [], 'adas_info': []}, {'lane_id': '237564', 'link_id': '75056', 'lane_idx_raw': 4, 'lane_type': 0, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 60, 'max_speed_limit': 120, 'width': 3.7699999809265137, 'length': 90.19000244140625, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731503', 'side': 0, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.14, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664078, 31.2648159], [121.1664412, 31.2647812], [121.1664745, 31.2647465], [121.1664977, 31.2647224], [121.1665209, 31.2646983], [121.1665544, 31.2646637], [121.1665879, 31.2646291], [121.1666091, 31.2646072], [121.1666303, 31.2645853], [121.1666637, 31.2645506], [121.1666971, 31.264516], [121.1667182, 31.2644941], [121.1667392, 31.2644723], [121.1667733, 31.2644381], [121.1668074, 31.264404], [121.166829, 31.2643823], [121.1668506, 31.2643607], [121.1668844, 31.2643264], [121.1669183, 31.264292], [121.1669396, 31.2642704], [121.1669609, 31.2642487], [121.1669888, 31.2642209], [121.1670167, 31.264193]]}}, {'mark_id': '731504', 'side': 1, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.23, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1663773, 31.2647944], [121.1664107, 31.2647597], [121.1664441, 31.264725], [121.1664674, 31.2647007], [121.1664908, 31.2646764], [121.1665243, 31.2646419], [121.1665578, 31.2646073], [121.166579, 31.2645854], [121.1666003, 31.2645635], [121.1666337, 31.2645288], [121.1666671, 31.2644941], [121.1666882, 31.2644722], [121.1667093, 31.2644503], [121.1667433, 31.264416], [121.1667773, 31.2643817], [121.1667987, 31.2643601], [121.1668202, 31.2643384], [121.1668541, 31.2643041], [121.166888, 31.2642698], [121.1669095, 31.2642481], [121.1669311, 31.2642264], [121.1669589, 31.2641987], [121.1669868, 31.264171]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.1663926, 31.2648052], [121.1664259, 31.2647705], [121.1664593, 31.2647358], [121.1664826, 31.2647116], [121.1665058, 31.2646874], [121.1665393, 31.2646528], [121.1665729, 31.2646182], [121.1665941, 31.2645963], [121.1666153, 31.2645744], [121.1666487, 31.2645397], [121.1666821, 31.2645051], [121.1667032, 31.2644832], [121.1667243, 31.2644613], [121.1667583, 31.2644271], [121.1667923, 31.2643928], [121.166814, 31.2643711], [121.1668356, 31.2643493], [121.1668695, 31.264315], [121.1669034, 31.2642806], [121.1669247, 31.2642591], [121.166946, 31.2642375], [121.1669739, 31.2642098], [121.1670018, 31.264182]]}, 'successor_lane_ids': ['237608'], 'precursor_lane_ids': ['237606'], 'obj_basic_vct': [], 'adas_info': []}, {'lane_id': '237567', 'link_id': '75056', 'lane_idx_raw': 5, 'lane_type': 0, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 60, 'max_speed_limit': 120, 'width': 3.740000009536743, 'length': 90.0999984741211, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731501', 'side': 0, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.06, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664381, 31.2648373], [121.1664713, 31.2648025], [121.1665046, 31.2647677], [121.1665276, 31.2647437], [121.1665506, 31.2647196], [121.1665843, 31.2646851], [121.1666179, 31.2646506], [121.1666391, 31.2646288], [121.1666603, 31.2646071], [121.1666937, 31.2645724], [121.1667271, 31.2645378], [121.1667481, 31.264516], [121.1667691, 31.2644943], [121.166803, 31.26446], [121.1668369, 31.2644257], [121.1668583, 31.264404], [121.1668797, 31.2643824], [121.1669137, 31.2643481], [121.1669477, 31.2643138], [121.1669692, 31.2642922], [121.1669907, 31.2642705], [121.1670185, 31.2642427], [121.1670464, 31.2642149]]}}, {'mark_id': '731502', 'side': 1, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.14, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664078, 31.2648159], [121.1664412, 31.2647812], [121.1664745, 31.2647465], [121.1664977, 31.2647224], [121.1665209, 31.2646983], [121.1665544, 31.2646637], [121.1665879, 31.2646291], [121.1666091, 31.2646072], [121.1666303, 31.2645853], [121.1666637, 31.2645506], [121.1666971, 31.264516], [121.1667182, 31.2644941], [121.1667392, 31.2644723], [121.1667733, 31.2644381], [121.1668074, 31.264404], [121.166829, 31.2643823], [121.1668506, 31.2643607], [121.1668844, 31.2643264], [121.1669183, 31.264292], [121.1669396, 31.2642704], [121.1669609, 31.2642487], [121.1669888, 31.2642209], [121.1670167, 31.264193]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.166423, 31.2648266], [121.1664563, 31.2647919], [121.1664896, 31.2647571], [121.1665127, 31.264733], [121.1665358, 31.2647089], [121.1665693, 31.2646744], [121.1666029, 31.2646398], [121.1666241, 31.264618], [121.1666453, 31.2645962], [121.1666787, 31.2645615], [121.1667121, 31.2645269], [121.1667332, 31.2645051], [121.1667542, 31.2644833], [121.1667882, 31.2644491], [121.1668222, 31.2644148], [121.1668437, 31.2643932], [121.1668652, 31.2643715], [121.1668991, 31.2643372], [121.166933, 31.2643029], [121.1669544, 31.2642813], [121.1669758, 31.2642596], [121.1670037, 31.2642318], [121.1670316, 31.264204]]}, 'successor_lane_ids': ['237571'], 'precursor_lane_ids': ['237611'], 'obj_basic_vct': [], 'adas_info': []}, {'lane_id': '237575', 'link_id': '75056', 'lane_idx_raw': 6, 'lane_type': 0, 'lane_status': 0, 'travel_direction': 1, 'min_speed_limit': 60, 'max_speed_limit': 120, 'width': 3.7799999713897705, 'length': 90.0199966430664, 'vehicle_type': 0, 'is_under_construction': False, 'lane_add_type': -1, 'lane_connect_type': -1, 'curr_turn_direction': 0, 'plan_turn_direction': 1, 'marking_list': [{'mark_id': '731499', 'side': 0, 'mark_type': 3, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 89.98, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664689, 31.264859], [121.166502, 31.2648241], [121.1665352, 31.2647893], [121.166558, 31.2647653], [121.1665808, 31.2647413], [121.1666144, 31.2647067], [121.1666479, 31.2646721], [121.1666689, 31.2646504], [121.16669, 31.2646286], [121.1667237, 31.2645941], [121.1667573, 31.2645596], [121.1667784, 31.264538], [121.1667995, 31.2645163], [121.1668334, 31.264482], [121.1668673, 31.2644477], [121.1668888, 31.2644259], [121.1669103, 31.2644042], [121.1669442, 31.2643698], [121.1669781, 31.2643355], [121.1669991, 31.2643142], [121.1670201, 31.2642929], [121.1670483, 31.264265], [121.1670764, 31.264237]]}}, {'mark_id': '731500', 'side': 1, 'mark_type': 1, 'color': 2, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 90.06, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664381, 31.2648373], [121.1664713, 31.2648025], [121.1665046, 31.2647677], [121.1665276, 31.2647437], [121.1665506, 31.2647196], [121.1665843, 31.2646851], [121.1666179, 31.2646506], [121.1666391, 31.2646288], [121.1666603, 31.2646071], [121.1666937, 31.2645724], [121.1667271, 31.2645378], [121.1667481, 31.264516], [121.1667691, 31.2644943], [121.166803, 31.26446], [121.1668369, 31.2644257], [121.1668583, 31.264404], [121.1668797, 31.2643824], [121.1669137, 31.2643481], [121.1669477, 31.2643138], [121.1669692, 31.2642922], [121.1669907, 31.2642705], [121.1670185, 31.2642427], [121.1670464, 31.2642149]]}}, {'mark_id': '805916', 'side': 0, 'mark_type': 17, 'color': 0, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 91.28, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664688, 31.2648742], [121.1664948, 31.264847], [121.1665202, 31.26482], [121.1665471, 31.2647915], [121.1665742, 31.2647632], [121.1666026, 31.2647358], [121.1666294, 31.2647073], [121.1666562, 31.2646788], [121.1666832, 31.2646503], [121.1667105, 31.2646221], [121.166738, 31.2645941], [121.1667656, 31.2645661], [121.1667933, 31.2645382], [121.1668207, 31.2645101], [121.1668481, 31.264482], [121.1668756, 31.2644539], [121.1669028, 31.2644257], [121.1669299, 31.2643973], [121.1669568, 31.2643689], [121.1669828, 31.2643398], [121.1670102, 31.2643116], [121.1670375, 31.2642835], [121.1670647, 31.2642552], [121.1670818, 31.2642411]]}}, {'mark_id': '10643831', 'side': 0, 'mark_type': 11, 'color': 0, 'material': 0, 'idx': 0, 'width': 0.0, 'length': 89.96, 'height': -1, 'order_num': -1, 'off_set': -1, 'barrier_type': -1, 'barrier_sub_type': -1, 'mark_add_type': -1, 'geometry': {'type': 'LineString', 'coordinates': [[121.1664742, 31.2648627], [121.1664875, 31.2648488], [121.1665074, 31.2648278], [121.1665272, 31.2648068], [121.1665471, 31.2647858], [121.166567, 31.2647648], [121.1665869, 31.2647438], [121.1666069, 31.2647229], [121.1666269, 31.264702], [121.166647, 31.2646812], [121.1666671, 31.2646603], [121.1666871, 31.2646394], [121.1667073, 31.2646186], [121.1667275, 31.2645979], [121.1667478, 31.2645772], [121.166768, 31.2645565], [121.1667881, 31.2645356], [121.1668081, 31.2645147], [121.1668285, 31.264494], [121.1668489, 31.2644734], [121.1668698, 31.2644531], [121.1668907, 31.2644329], [121.1669111, 31.2644123], [121.1669316, 31.2643917], [121.1669518, 31.264371], [121.1669721, 31.2643502], [121.1669928, 31.2643298], [121.1670134, 31.2643094], [121.1670341, 31.2642889], [121.1670547, 31.2642684], [121.1670822, 31.2642414]]}}], 'geometry': {'type': 'LineString', 'coordinates': [[121.1664535, 31.2648481], [121.1664867, 31.2648133], [121.1665199, 31.2647785], [121.166543, 31.2647543], [121.166566, 31.2647302], [121.1665996, 31.2646956], [121.1666332, 31.2646611], [121.1666543, 31.2646393], [121.1666754, 31.2646176], [121.166709, 31.264583], [121.1667425, 31.2645484], [121.1667635, 31.2645267], [121.1667846, 31.264505], [121.1668185, 31.2644707], [121.1668524, 31.2644364], [121.1668739, 31.2644147], [121.1668953, 31.264393], [121.1669292, 31.2643587], [121.1669632, 31.2643244], [121.1669844, 31.2643029], [121.1670057, 31.2642814], [121.1670335, 31.2642537], [121.1670614, 31.264226]]}, 'successor_lane_ids': ['237621'], 'precursor_lane_ids': ['237563'], 'obj_basic_vct': [], 'adas_info': []}]}], 'uploader': 'yufeng', 'upload_timestamp': 1634113782949},
{'map_version': 'baidu_10124', 'event_type': 4, 'event_gps': {'type': 'Point', 'coordinates': [121.16617594, 31.28427127]}, 'geofence_event_segments': [{'link_id': '1055909', 'offset_start': 0, 'offset_end': 1200, "geofence_configuration": [{"road_scenario_type": 1, "action_type": 1, "lane_idx": [123, 123], "function_type": [123, 123], "time_range": {"start_time": 1634180650, "end_time": 1634180650}}]}], 'uploader': 'xiefei', 'upload_timestamp': 1634284043, 'commit_content': '20211015_geofence_test4'}
]


class TestHdMap:
    @pytest.mark.parametrize("event_data, des", zip(param_event_data, case), ids=case)
    def test_hd_map(self, event_data, des, kafka, mysql, mongodb):
        """
        本测试用例模拟AS云端向TSP推送地图数据
        rvs消费topic swc-cvs-tsp-test-80001-rvs-hdmap的数据并解析，分别存储至mysql和mongo中
        :param kafka:
        :param mysql:
        :param mongodb:
        :return:
        """
        with allure.step("向hdmap topic推送地图数据"):
            sample_time = round(time.time())
            hd_map_event = {"map_version":"baidu_10125","link_id":"{75056,888888,75054}","event_id":"baidu_10125_1015test", 'area_code': '310114', "event_gps": {"type": "Point", "coordinates": [121.16617594, 31.28427127]}}
            hd_map_event['sample_time'] = sample_time
            hd_map_event['event_id'] = f"cvs_test_10125_{sample_time}"
            hd_map_event['event_type'] = event_data['event_type']
            hd_map_event['description'] = f"test_{des.split(' ')[-1]}"
            event_data['event_id'] = f"cvs_test_10125_{sample_time}"
            hd_map_event['event_data'] = base64.standard_b64encode(str.encode(json.dumps(event_data))).decode()
            print(hd_map_event['event_data'])
            print(base64.b64decode(hd_map_event['event_data']))
            kafka['comn'].produce(kafka['topics']['hdmap'], json.dumps(hd_map_event))
            time.sleep(5)

        with allure.step("检验mysql rvs_data数据库的存储"):
            hdmap_in_mysql = mysql['rvs_data'].fetch_one('adc_hdmap_event', {'event_id': hd_map_event['event_id']},
                                                         fields=['map_version', 'description', 'event_id', 'event_type',
                                                                 'area_code', 'link_id', 'sample_time'])
            hd_map_event.pop('event_data')
            event_gps = hd_map_event.pop('event_gps')
            hd_map_event['sample_time'] = timestamp_to_utc_strtime(sample_time*1000)
            assert_equal(hdmap_in_mysql, hd_map_event)

        with allure.step("检验mongo的存储"):
            hdmap_in_mongo = mongodb['rvs'].find('adc_hdmap_event', {"event_id": hd_map_event['event_id']})[0]
            assert_equal(hdmap_in_mongo['event_gps'], event_gps['coordinates'])
            assert_equal(json.loads(hdmap_in_mongo['event_body']), event_data)





